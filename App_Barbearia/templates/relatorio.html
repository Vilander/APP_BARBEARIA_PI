{% extends 'base.html' %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
{% block body %}

<div class="container mt-5 mb-5">
  <div class="card-relatorio p-4">
    <h2 class="text-center mb-4">Relatório de Agendamentos e Lucros</h2>

    <form method="GET" class="mb-4">
      <div class="row align-items-end justify-content-center">
        <div class="col-md-3 mb-3">
          <label for="data_inicio" class="form-label">Data de Início</label>
          <input type="date" class="form-control" id="data_inicio" name="data_inicio" value="{{ data_inicio }}">
        </div>
        <div class="col-md-3 mb-3">
          <label for="data_fim" class="form-label">Data de Fim</label>
          <input type="date" class="form-control" id="data_fim" name="data_fim" value="{{ data_fim }}">
        </div>
        <div class="col-md-2 mb-3">
          <button type="submit" class="btn btn-primary w-100">Filtrar</button>
        </div>
      </div>
    </form>

    <div class="text-center mb-4">
      <h3 style="color: #4CAF50;">Lucro Total: R$ {{ total_valor_formatado }}</h3>
    </div>

    <!-- Gráficos empilhados em telas pequenas e lado a lado em telas maiores -->
    <div class="row mt-4">
      <!-- Gráfico de Agendamentos por Dia -->
      <div class="col-12 mb-4">
        <div class="card card-grafico card-relatorio-graph p-3">
          <h5 class="text-center mb-3">Número de Agendamentos</h5>
          <canvas id="agendamentosChart" class="grafico"></canvas>
        </div>
      </div>

      <!-- Gráfico de Tipo de Serviço -->
      <div class="col-12 mb-4">
        <div class="card card-grafico card-relatorio-graph p-3">
          <h5 class="text-center mb-3">Tipos de Serviço</h5>
          <canvas id="servicosChart" class="grafico"></canvas>
        </div>
      </div>

      <!-- Novo Gráfico de Linha para Lucro -->
      <div class="col-12 mb-4">
        <div class="card card-grafico card-relatorio-graph p-3">
          <h5 class="text-center mb-3">Lucro Diário</h5>
          <canvas id="lucroChart" class="grafico"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Pega os dados do Flask
  const dadosAgendamentos = JSON.parse('{{ dados_agendamentos | tojson }}');
  const dadosServicos = JSON.parse('{{ dados_servicos | tojson }}');
  const dadosLucroDiario = JSON.parse('{{ dados_lucro_diario | tojson }}');

  // Configuração do Gráfico de Agendamentos por Dia
  const agendamentosCtx = document.getElementById('agendamentosChart').getContext('2d');
  new Chart(agendamentosCtx, {
    type: 'bar',
    data: {
      labels: Object.keys(dadosAgendamentos),
      datasets: [{
        label: 'Número de Agendamentos',
        data: Object.values(dadosAgendamentos),
        backgroundColor: '#6A994E',
        borderColor: '#6A994E',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  // Configuração do Gráfico de Tipo de Serviço
  const servicosCtx = document.getElementById('servicosChart').getContext('2d');
  const servicosLabels = Object.keys(dadosServicos);
  const servicosData = Object.values(dadosServicos);

  // Define cores de forma manual para manter a consistência
  const cores = ['#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
  const backgroundColors = servicosLabels.map((_, i) => cores[i % cores.length]);

  new Chart(servicosCtx, {
    type: 'doughnut',
    data: {
      labels: servicosLabels,
      datasets: [{
        label: 'Quantidade de Serviços',
        data: servicosData,
        backgroundColor: backgroundColors,
        hoverOffset: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
        },
        tooltip: {
          callbacks: {
            label: function(tooltipItem) {
              const label = tooltipItem.label || '';
              const value = tooltipItem.raw || 0;
              const total = tooltipItem.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
              const percentage = ((value / total) * 100).toFixed(2);
              return `${label}: ${value} (${percentage}%)`;
            }
          }
        }
      }
    }
  });

  // Novo Gráfico de Lucro Diário
  const lucroCtx = document.getElementById('lucroChart').getContext('2d');
  new Chart(lucroCtx, {
    type: 'line',
    data: {
      labels: Object.keys(dadosLucroDiario),
      datasets: [{
        label: 'Lucro Diário (R$)',
        data: Object.values(dadosLucroDiario),
        fill: true,
        borderColor: '#007BFF',
        backgroundColor: 'rgba(0, 123, 255, 0.2)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
</script>
{% endblock body %}